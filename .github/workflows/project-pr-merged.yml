name: Update Project Status - QA or Done

on:
  pull_request:
    types: [closed]

jobs:
  update-status:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    steps:
      - name: Get project data
        id: project-data
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ADD_TO_PROJECT_PAT }}
          script: |
            const query = `query($owner:String!, $number:Int!) {
              repository(owner:$owner, name:"{{REPO_NAME}}") {
                issue(number:$number) {
                  projectItems(first:10) {
                    nodes {
                      id
                      project {
                        id
                        title
                      }
                    }
                  }
                }
              }
            }`;
            
            const variables = {
              owner: context.repo.owner,
              number: context.issue.number
            };
            
            const result = await github.graphql(query, variables);
            const items = result.repository.issue.projectItems.nodes;
            
            if (items.length === 0) {
              console.log('Issue not linked to any project');
              return;
            }
            
            const projectItem = items.find(item => 
              item.project.title === '{{PROJECT_TITLE}}'
            );
            
            if (!projectItem) {
              console.log('Issue not in {{PROJECT_TITLE}} project');
              return;
            }
            
            core.setOutput('item-id', projectItem.id);
            core.setOutput('project-id', projectItem.project.id);

      - name: Determine target status
        id: target-status
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = context.payload.pull_request.head.ref;
            const isRelease = branchName.startsWith('release/');
            const targetStatus = isRelease ? 'Done' : 'QA/Testing';
            core.setOutput('status', targetStatus);
            console.log(`Target status: ${targetStatus}`);

      - name: Get Status field ID
        if: steps.project-data.outputs.item-id
        id: field-id
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ADD_TO_PROJECT_PAT }}
          script: |
            const query = `query($projectId:ID!) {
              node(id:$projectId) {
                ... on ProjectV2 {
                  fields(first:20) {
                    nodes {
                      ... on ProjectV2SingleSelectField {
                        id
                        name
                        options {
                          id
                          name
                        }
                      }
                    }
                  }
                }
              }
            }`;
            
            const variables = {
              projectId: '${{ steps.project-data.outputs.project-id }}'
            };
            
            const result = await github.graphql(query, variables);
            const fields = result.node.fields.nodes;
            const statusField = fields.find(f => f.name === 'Status');
            
            if (!statusField) {
              core.setFailed('Status field not found');
              return;
            }
            
            const targetOption = statusField.options.find(o => 
              o.name === '${{ steps.target-status.outputs.status }}'
            );
            
            if (!targetOption) {
              core.setFailed('Target status option not found');
              return;
            }
            
            core.setOutput('field-id', statusField.id);
            core.setOutput('option-id', targetOption.id);

      - name: Update status
        if: steps.field-id.outputs.field-id
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ADD_TO_PROJECT_PAT }}
          script: |
            const mutation = `mutation($projectId:ID!, $itemId:ID!, $fieldId:ID!, $optionId:String!) {
              updateProjectV2ItemFieldValue(input: {
                projectId: $projectId
                itemId: $itemId
                fieldId: $fieldId
                value: {singleSelectOptionId: $optionId}
              }) {
                projectV2Item {
                  id
                }
              }
            }`;
            
            const variables = {
              projectId: '${{ steps.project-data.outputs.project-id }}',
              itemId: '${{ steps.project-data.outputs.item-id }}',
              fieldId: '${{ steps.field-id.outputs.field-id }}',
              optionId: '${{ steps.field-id.outputs.option-id }}'
            };
            
            await github.graphql(mutation, variables);
            console.log('Status updated to ${{ steps.target-status.outputs.status }}');
